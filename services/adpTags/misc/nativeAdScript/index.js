var res = {
	response_status: 0,
	status_message: '',
	products: [
		{
			title: 'Provogue Running Shoes',
			description:
				'Rs499 Provogue Running Shoes. Best quality and affordable shoes. Available till stock lasts. ',
			price: 'Rs499',
			call_to_action: 'Shop Now',
			click_url:
				'https://cat.hk.as.criteo.com/delivery/ckn.php?cppv=1&cpp=PbB5kHxTOEdQU3NxSkg2WWd1R3MzOHB4ZURobmQvY3c1c1Bkcm5uYXNWN05sNGlSUkpKZVE4OW01c2QyNHFyNzMvbXB4d2ZhaWZEN1JlVUkxdjdja3hseUZ1TElDU1pKT2tabERxZ1FpRmxyUFBPTWFZVjRTVmVMTVdmekhhTk1hNlA0ckpGNEN4eFcvTWlVczlaZFNtb0lRY0t0WVJTWWZvKzZqT0RYT09GNlByT2pJdWs0MUZyMkVpTkc5SWliN0pYRnk3OE9ZUEw4TStoWmhkRVRmcW9wemtQNzVoWlFVS1FQS2dtL1RPQjA5b3puZ2svTXJGVmlyYnlGK2FxWFZXQUdVZ295UkdGUVBoOWN3Qi9heiszcVNvcnVzSlBRL1haemdKNWhkV2JGQS9SdTA2cnpTOGNTUHVjWDhwMUMxVXU5VHw%3D&maxdest=http%3A%2F%2Fwww.flipkart.com%2Fprovogue-running-shoes%2Fp%2Fitmedy8pspqhntsk%3Fpid%3DSHOEDY8P4R9YGJGD%26cmpid%3Dcontent_appretar_FootWearFitness_MenFW_criteo',
			image: {
				url:
					'https://pix.hk.as.criteo.net/img/img?c=1&h=400&i=13746-shoedy8p4r9ygjgd&m=1&q=80&r=0&u=http%3A%2F%2Fimg.fkcdn.com%2Fimage%2Fshoe%2Fh%2Fy%2Fz%2Fblue-pv1094-provogue-45-1100x1100-imaedvujrzdqyr2d.jpeg&w=400&s=VG6lJ2GV5-SZlgvB4cUsXHjp',
				width: 400,
				height: 400
			}
		}
	],
	advertiser: {
		logo: {
			url:
				'https://pix.hk.as.criteo.net/img/img?h=200&i=13746-&m=1&p=1&q=100&r=0&u=http%3A%2F%2Fstatic.hk.as.criteo.net%2Fdesign%2Fdt%2F13746%2F160707%2F7666b28c56f646ada2186b6c03fef25a_privacy-logo.png&w=200&s=uZzdzz79haPHbjmanILOiUDb',
			width: 200,
			height: 200
		},
		logo_click_url:
			'https://cat.hk.as.criteo.com/delivery/ckn.php?cppv=1&cpp=cLqhOHxTOEdQU3NxSkg2WWd1R3MzOHB4ZURobmQvY3c1c1Bkcm5uYXNWN05sNGlSUkpKZVE4OW01c2QyNHFyNzMvbXB4d2ZhaWZEN1JlVUkxdjdja3hseUZ1TElDU1pKT2tabERxZ1FpRmxyUFBPTWFZVjRTVmVMTVdmekhhTk1hNlA0ckpGNEN4eFcvTWlVczlaZFNtb0lRY0t0WVJTWWZvKzZqT0RYT09GNlByT2hSN1hBNFh5MUNkQmlBNi9KbTRzZlNxdEw4eXB0cDhXK1hYV0ZLaVFiZ0ZxcnlZeHFYeDdicW5OV1hsaWlMeDZhVjVuOHJIQ0RPaFBHN2V5bUZ4S0d1cTE0RlArK3Q0OUZLWGVCc0l6UnZYK3gxWnV2MUthaUZja1l6MDNkdnZVYz18&maxdest=http%3A%2F%2Fwww.flipkart.com%3Fcontent_appretar_homepage_criteo',
		description: 'Flipkart',
		domain: 'flipkart.com',
		legal_text: ''
	},
	privacy: {
		optout_click_url:
			'https://info.criteo.com/privacy/informations?infonorm=3&partner=13746&campaignid=103682&zoneid=668930&bannerid=7739150&displayid=0dacaa4445&uaCap=0&aid=r0feQ3w3TnhxZERVZFg2THkvQTZUdURibklhb1l1L1p1Tjk4MEtGNjJwOGFxK2IwPXw=',
		optout_image_url: 'https://static.criteo.net/flash/icon/nai_small.png'
	},
	impression_pixels: [
		{
			url:
				'https://cat.hk.as.criteo.com/delivery/lgn.php?cppv=1&cpp=fu32YnxTOEdQU3NxSkg2WWd1R3MzOHB4ZURobmQvY3c1c1Bkcm5uYXNWN05sNGlSUkpKZVE4OW01c2QyNHFyNzMvbXB4d2ZhaWZEN1JlVUkxdjdja3hseUZ1TElDU1pKT2tabERxZ1FpRmxyUFBPTWFZVjRTVmVMTVdmekhhTk1hNlA0clZIVFM1TDY0WEdxRHoxUWwrdmFMemNaZnhxUzdoOUMzcUJqWTJVU0lwN0h6WlE3RE9SSkZIcTR5UjB3YUJ2S3pOcDU2OENKUXAveXFqRHFTaUpoK0M5WlBrTUVlNTR0SVRDQmN0V1Z2U3VYV2tKZmVtcXYxRC9LWTZ1a3U3ZlQ5M2s1Wm9rUHZmOCt4aVJLWDAxS0JIMTZCYmMyUTVCNUxnL1M0eHNMMDVjc1FOeFYwSXR5Rmo0Ujh2NW1yR1NGL3w%3D'
		}
	]
};

function createAd(parent, image, title, description, btnText, btnLink, advertiserInfo, privacyInfo) {
	var adStyles = {
		container:
			'background-color: transparent; margin: 5px 0; display: -webkit-box; display: -ms-flexbox; display: flex; cursor: pointer; align-items: center; -webkit-box-align: center; -ms-flex-align: center;  -webkit-box-pack: start; -ms-flex-pack: start; justify-content: flex-start; text-decoration: none; flex-wrap: wrap; -webkit-transition: all 0.3s ease-in-out; -moz-transition: all 0.3s ease-in-out; -o-transition: all 0.3s ease-in-out; -ms-transition: all 0.3s linear; transform: translateZ(0); -webkit-backface-visibility: hidden;  -ms-transform: translateZ(0); -webkit-transform: translateZ(0); padding: 10px 0; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd;',
		text:
			'font-size: 12px; color: #414141; text-align: left; font-family:inherit; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; margin: 0;',
		button:
			'background-color: #27ae60; line-height: 25px; max-height:30px; color: #fff; padding: 0 6px; font-size: 14px; border: 0; box-shadow: 0; cursor: pointer; font-family:inherit; border-radius: 4px; order: 3;',
		contentDiv: 'margin-right: 10px; max-width: 68%; max-height: 45px; overflow: hidden; order: 2;',
		adTag: 'font-size: 12px; order: 4; color: #414141; font-family: inherit;',
		advertiser:
			'font-size: 10px; position: absolute; opacity: 0; -webkit-transition: -webkit-transform 0.3s, opacity 0.3s; -moz-transition: -moz-transform 0.3s, opacity 0.3s; transition: transform 0.3s, opacity 0.3s; -webkit-transform: translateY(-100%); -moz-transform: translateY(-100%); transform: translateY(-100%);'
	};

	function createImage(imageUrl, container) {
		return new Promise(function(resolve, reject) {
			var canvas = document.createElement('canvas'),
				ctx = canvas.getContext('2d');

			canvas.style.marginRight = '15px';
			canvas.style.order = '1';

			img = new Image();
			img.onload = function() {
				// Setting height to 50px
				canvas.height = 45;

				// Find proportional image
				canvas.width = canvas.height * (img.width / img.height);

				// For smoothing
				var oc = document.createElement('canvas'),
					octx = oc.getContext('2d');

				oc.width = img.width * 0.5;
				oc.height = img.height * 0.5;
				octx.drawImage(img, 0, 0, oc.width, oc.height);

				// Clipping
				ctx.drawImage(oc, 0, 0, oc.width, oc.height, 0, 0, canvas.width, canvas.height);

				// Adding to container
				container.appendChild(canvas);
				resolve();
			};
			img.src = imageUrl;
		});
	}

	function setContent(title, description, container, advertiserInfo) {
		return new Promise(function(resolve, reject) {
			var contentDiv = document.createElement('div'),
				contentPara = document.createElement('p'),
				titleSpan = document.createElement('span'),
				advertiserPara = document.createElement('p'),
				advertiserName = 'Ads by ';

			titleSpan.innerText = title;

			if (description.length > 120) {
				description = description.substr(0, 120).trim() + '...';
			}

			titleSpan.setAttribute('style', adStyles.text);
			contentPara.setAttribute('style', adStyles.text);
			contentDiv.setAttribute('style', adStyles.contentDiv);
			contentDiv.setAttribute('id', 'custom-ad-adpushup-content');

			titleSpan.style.fontWeight = 700;
			titleSpan.style.fontSize = '14px';
			titleSpan.style.marginRight = '10px';

			if (advertiserInfo.domain.length < advertiserInfo.description.length) {
				advertiserPara.innerText = advertiserName + advertiserInfo.domain;
			} else {
				advertiserPara.innerText = advertiserName + advertiserInfo.description;
			}

			advertiserPara.setAttribute('style', adStyles.advertiser);
			advertiserPara.setAttribute('id', 'custom-ad-advertiser-info');
			//             advertiserPara.style.visibility = 'hidden';

			contentPara.appendChild(titleSpan);
			contentPara.innerHTML = contentPara.innerHTML + description;

			contentDiv.appendChild(contentPara);
			contentDiv.appendChild(advertiserPara);
			container.appendChild(contentDiv);

			resolve();
		});
	}

	function setButton(btnText, btnLink, container) {
		return new Promise(function(resolve, reject) {
			var button = document.createElement('a');

			button.innerText = btnText;
			button.setAttribute('href', btnLink);

			button.setAttribute('style', adStyles.button);
			button.style.marginRight = '10px';

			container.appendChild(button);
			resolve();
		});
	}

	function setAdTag(container, privacyInfo) {
		var adTag = document.createElement('a'),
			adTagText = document.createElement('span'),
			optOutLink = document.createElement('span'),
			optOutImg = document.createElement('img');

		adTag.setAttribute('style', adStyles.adTag);
		adTag.href = privacyInfo.optout_click_url;
		adTag.setAttribute('target', '_blank');
		optOutImg.src = privacyInfo.optout_image_url;
		adTagText.innerText = 'Ad';

		adTagText.style.padding = '0px';
		adTagText.style.margin = '0px';
		optOutImg.style.width = '16px';
		optOutImg.style.height = '12px';
		optOutImg.style.verticalAlign = 'sub';
		//         adTagText.style.verticalAlign = '-webkit-baseline-middle';
		adTagText.style.visibility = 'hidden';
		adTagText.setAttribute('id', 'custom-ad-adtag');

		optOutLink.appendChild(optOutImg);
		adTag.appendChild(adTagText);
		adTag.appendChild(optOutLink);

		container.appendChild(adTag);
	}

	function processing() {
		var container = document.createElement('div');
		parent = document.querySelector(parent);

		container.style.width = parent.offsetWidth;
		container.style.height = '50px';
		container.setAttribute('id', 'custom-ad-js-adpushup');
		container.setAttribute('style', adStyles.container);

		return setContent(title, description, container, advertiserInfo)
			.then(function() {
				return setButton(btnText, btnLink, container);
			})
			.then(function() {
				return setAdTag(container, privacyInfo);
			})
			.then(function() {
				return createImage(image, container);
			})
			.then(function() {
				return Promise.resolve(parent.appendChild(container));
			});
	}
	return processing().then(function() {
		var adUnit = document.getElementById('custom-ad-js-adpushup'),
			advertiserInfo = document.getElementById('custom-ad-advertiser-info'),
			adTag = document.getElementById('custom-ad-adtag');
		// Setting up scaling event listeners
		adUnit.addEventListener('mouseover', function(e) {
			advertiserInfo.style.opacity = 1;
			advertiserInfo.style.transform = 'translateY(0%)';
			adTag.style.visibility = 'visible';
			adUnit.style.border = '0px';
		});
		adUnit.addEventListener('mouseout', function(e) {
			adTag.style.visibility = 'hidden';
			adUnit.style.border = '0px';
			advertiserInfo.style.opacity = '0';
			advertiserInfo.style.transform = 'translateY(-100%)';
		});
		function getWidth() {
			if (self.innerWidth) {
				return self.innerWidth;
			}

			if (document.documentElement && document.documentElement.clientWidth) {
				return document.documentElement.clientWidth;
			}

			if (document.body) {
				return document.body.clientWidth;
			}
		}
		var contentDiv = document.getElementById('custom-ad-adpushup-content');
		if (getWidth() < 700 || parent.offsetWidth < 700) {
			contentDiv.style.flex = '1';
		}
	});
}

function init() {
	var s = document.createElement('script');
	s.type = 'text/javascript';
	s.src = '//cas.criteo.com/delivery/0.1/napi.jsonp?zoneid=668930&callback=renderAd';
	var h = document.getElementsByTagName('script')[0];
	h.parentNode.insertBefore(s, h);
}

function renderAd(response) {
	if (response.response_status !== 0) {
		response = res;
	}
	var { image, click_url, title, call_to_action, description } = response.products[0];
	var advertiserInfo = response.advertiser;
	var privacyInfo = response.privacy;
	// createAd(parent-css-selector, imageUrl, title, description, btn-text, ad-url)
	createAd('#test', image.url, title, description, call_to_action, click_url, advertiserInfo, privacyInfo);
	//createAd('#test', image.url, title, description, call_to_action, click_url, advertiserInfo, privacyInfo);
}

init();
