include ../mixins/mixins

doctype html
html(lang="en")
    block getTitle

    head
        block head
                meta(charset="UTF-8")
                block headCss
                    link(href='http://fonts.googleapis.com/css?family=Karla', rel='stylesheet', type='text/css')
                    if environment == "production"
                        link(href="/assets/css/builds/website.min.css", rel="stylesheet", type="text/css")
                    else
                        link(href="/assets/css/libs/website.css", rel="stylesheet", type="text/css")

                link(id="favicon", rel="shortcut icon", href="/assets/images/favicon.ico", sizes="48x48", type="image/png")
                title #{titleVar + " - AdPushup"}

                block headScripts
                    if environment == "production"
                        script(type='text/javascript', src='//code.jquery.com/jquery-1.11.2.min.js')
                    else
                        script(type='text/javascript', src='/assets/js/libs/third-party/jquery-3.1.0.min.js')

                    script(type='text/javascript').
                        window.apjQuery = window.jQuery;
                        $('document').ready(function() {
                            window.currentUser = !{JSON.stringify(currentUser)};
                        });

                    - var baseLibsStr = "/assets/js/builds/";
                    - var baseLibsFinalStr = (environment == "production") ? (baseLibsStr + "base-libs.min.js") : ("/assets/js/libs/custom/base-libs.js");
                    +loadAsset("js", [baseLibsFinalStr])

                    if environment == "production"
                        script(type='text/javascript').
                            var currentUser = !{JSON.stringify(currentUser)};
                            var sites = (Object.keys(currentUser).length > 0) ? currentUser.sites : [];
                            var siteInfo = "", segmentAppId = !{JSON.stringify(consts.analytics["SEGMENT_APP_ID"])};

                            ((window.adpushup = window.adpushup || {}).user = (window.adpushup.user || {})).sites = sites;
                            //Segment Analytics Starts
                            !function () {
                                var analytics = window.analytics = window.analytics || [];
                                if (!analytics.initialize)if (analytics.invoked)window.console && console.error && console.error("Segment snippet included twice."); else {
                                    analytics.invoked = !0;
                                    analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "group", "track", "ready", "alias", "page", "once", "off", "on"];
                                    analytics.factory = function (t) {
                                        return function () {
                                            var e = Array.prototype.slice.call(arguments);
                                            e.unshift(t);
                                            analytics.push(e);
                                            return analytics
                                        }
                                    };
                                    for (var t = 0; t < analytics.methods.length; t++) {
                                        var e = analytics.methods[t];
                                        analytics[e] = analytics.factory(e)
                                    }
                                    analytics.load = function (t) {
                                        var e = document.createElement("script");
                                        e.type = "text/javascript";
                                        e.async = false;
                                        e.src = ("https:" === document.location.protocol ? "https://" : "http://") + "cdn.segment.com/analytics.js/v1/" + t + "/analytics.min.js";
                                        e.onload = function () {
                                            window.overrideTrackers();
                                        };
                                        var n = document.getElementsByTagName("script")[0];
                                        n.parentNode.insertBefore(e, n)
                                    };
                                    analytics.SNIPPET_VERSION = "3.0.1";
                                    analytics.load(segmentAppId);
                                }
                            }();
                            window.overrideTrackers();
    body
        if environment == "production"
            block analyticsIdentify
                // Intercom user secure mode Hash
                - intercomHash = utils.getHmacSHA256(currentUser.email, consts.analytics["INTERCOM_ID"]);
                script(type="text/javascript").
                    var intercomHash = '#{intercomHash}',
                        intercomObj = {
                            Intercom: {
                                user_hash: intercomHash
                            }
                        };
                    if (Object.keys(window.currentUser).length > 0 && (sites.length > 0)) {
                        sites.map(function (obj, idx) {
                            siteInfo += obj.siteId + " " + obj.domain + " | ";
                        });
                    }
            script(type="text/javascript" src="/assets/js/libs/custom/adpushup-analytics.js")
            script(type="text/javascript").
                if (window.currentUser.email) {
                    var data = {
                        email: window.currentUser.email,
                        analytics: {
                            name: (window.currentUser.firstName + ((window.currentUser.lastName && window.currentUser.lastName.length > 0) ? ' ' + window.currentUser.lastName : "")),
                            email: window.currentUser.email,
                            sites: siteInfo
                        },
                        intercom: intercomObj
                    }
                    adpushupAnalyticsEvents.emit('analyticsIdentify', data);
                }
        else
            script(type="text/javascript" src="/assets/js/libs/custom/adpushup-analytics-mockup.js")

    body
        block bodyContent
        div(id="freeow-tr", class="freeow freeow-top-right")
