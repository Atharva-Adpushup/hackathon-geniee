const { promiseForeach } = require('node-utils');

const siteModel = require('../../../../models/siteModel');
const { fetchAllSites, errorHandler } = require('./helpers');

function siteProcessing(adsContainer, site) {
	return siteModel
		.getSiteById(site.siteId)
		.then(site => site.getAllChannels())
		.then(channels => {
			channels.foreach(channel => {
				const { variations = {} } = channel;
				const variationIds = Object.keys(variations);
				variationIds.foreach(variationId => {
					const variation = variations[variationId];
					const { sections = {} } = variation;
					const sectionIds = Object.keys(sections);
					sectionIds.foreach(id => {
						const section = sections[id];
						if (section.type === 3 || section.type === 4) {
							const { ads } = sections;
						}
					});
				});
			});
		})
		.catch(err => {
			console.log('Error while processing innovative ads status for site', siteId);
			console.log(err); 
			return false;
		});
}

function processing(sites) {
	if (!sites || !sites.length) {
		throw new Error('No Sites available');
	}
	let ads = [];
	return promiseForeach(sites, siteProcessing.bind(null, ads), errorHandler);
}

function init() {
	return fetchAllSites()
		.then(processing)
		.catch(err => console.log('Error occured : ', err));
}

// init()
// 	.then(() => console.log('Processing over'))
// 	.then(() => process.exit(0));


/**
 * Flow: 
 * - Fetch All Sites
 * - Loop for each site
 * 		- Fetch All Channels
 * 		- Loop for each channel
 * 			- Find all variations
 * 			- Find all sections
 * 				- If section is of type 3 or 4 then push to new fmrt doc with all the relevant ad details
 * Problems
 * 	1. If in a pagegroup there are multiple ads of same type (stickyBottom/left/right/docked) in different variaitons then which one to choose for new doc?
 */